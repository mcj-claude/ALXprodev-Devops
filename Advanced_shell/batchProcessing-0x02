#!/bin/bash

# batchProcessing-0x02 – Enhanced with retry logic and error handling

POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
OUTPUT_DIR="pokemon_data"
MAX_RETRIES=3
DELAY=2  # seconds between retries

# Create output directory
mkdir -p "$OUTPUT_DIR"

echo "Starting batch fetch with retry logic..."

for pokemon in "${POKEMON_LIST[@]}"; do
    filename="$OUTPUT_DIR/${pokemon,,}.json"
    attempt=0
    success=false

    echo -n "Fetching $pokemon... "

    while [[ $attempt -lt $MAX_RETRIES ]] && [[ $success == false ]]; do
        attempt=$((attempt + 1))

        if curl -s -f -L --connect-timeout 10 \
                "https://pokeapi.co/api/v2/pokemon/$pokemon" \
                -o "$filename" --write-out "%{http_code}" | grep -qE "^2[0-9]{2}$"; then
            success=true
            echo "Success (attempt $attempt)"
        else
            echo -n "Failed (attempt $attempt/$MAX_RETRIES)"
            if [[ $attempt -lt $MAX_RETRIES ]]; then
                echo -n ", retrying in $DELAY seconds..."
                sleep $DELAY
            else
                echo " [FAILED]"
                echo "ERROR: Failed to fetch $pokemon after $MAX_RETRIES attempts" >&2
                # Create empty file or remove partial one
                rm -f "$filename"
            fi
        fi
    done

    # Respectful delay between Pokémon (avoid rate limiting)
    sleep 1
done

echo "Batch processing completed!"